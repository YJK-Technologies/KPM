name: KPM Auto Deploy (IIS + PM2)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # -------------------------------------------------
      # 0Ô∏è‚É£ CLEAN OLD WORKSPACE (CRITICAL FOR SELF-HOSTED)
      # -------------------------------------------------
      - name: Clean runner workspace
        shell: powershell
        run: |
          Write-Host "Cleaning old workspace..."
          if (Test-Path "$env:GITHUB_WORKSPACE") {
            Get-ChildItem "$env:GITHUB_WORKSPACE" -Force | Remove-Item -Recurse -Force
          }

      # -------------------------------------------------
      # 1Ô∏è‚É£ Capture JOB START TIME (IST)
      # -------------------------------------------------
      - name: Capture Job Start Time (IST)
        shell: powershell
        run: |
          $ist = Get-Date
          $log = "D:\Action-Runners\kpm-runner\_diag\job-runtime-IST.log"
          "START | $($ist.ToString('yyyy-MM-dd HH:mm:ss')) | Repo=$env:GITHUB_REPOSITORY | RunId=$env:GITHUB_RUN_ID" | Out-File -Append $log

      # -------------------------------------------------
      # 2Ô∏è‚É£ Checkout source (FORCE CLEAN)
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 0

      # -------------------------------------------------
      # 3Ô∏è‚É£ Setup Node.js
      # -------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # -------------------------------------------------
      # 4Ô∏è‚É£ Sync BACKEND code to IIS
      # -------------------------------------------------
      - name: Sync backend code to IIS
        shell: powershell
        run: |
          $src = "$env:GITHUB_WORKSPACE\backend"
          $dest = "C:\inetpub\wwwroot\kanakkuputhakam\server"

          if (!(Test-Path $src)) {
            Write-Error "Backend source folder not found: $src"
            exit 1
          }

          robocopy $src $dest /MIR /XD node_modules
          if ($LASTEXITCODE -le 7) { exit 0 } else { exit $LASTEXITCODE }

      # -------------------------------------------------
      # 5Ô∏è‚É£ Backend npm install (CLEAN)
      # -------------------------------------------------
      - name: Install backend dependencies
        shell: powershell
        run: |
          cd C:\inetpub\wwwroot\kanakkuputhakam\server
          if (Test-Path node_modules) {
            Remove-Item -Recurse -Force node_modules
          }
          npm ci --legacy-peer-deps

      # -------------------------------------------------
      # 6Ô∏è‚É£ Restart backend via PM2
      # -------------------------------------------------
      # - name: Restart backend
      #   shell: powershell
      #   run: |
      #     if (pm2 list | Select-String "KPM") {
      #       pm2 restart KPM
      #     } else {
      #       pm2 start C:\inetpub\wwwroot\kanakkuputhakam\server\https.js --name KPM
      #     }
      #     pm2 save

      - name: Restart backend (NSSM)
        shell: powershell
        run: |
          $serviceName = "KPM"
          $nssm = "C:\Windows\System32\nssm.exe"
          $node = "C:\Program Files\nodejs\node.exe"
          $app = "C:\inetpub\wwwroot\kanakkuputhakam\server\https.js"
          $appDir = "C:\inetpub\wwwroot\kanakkuputhakam\server"

          if (Get-Service -Name $serviceName -ErrorAction SilentlyContinue) {
              Write-Host "Service exists. Restarting..."
              & $nssm restart $serviceName
          }
          else {
              Write-Host "Service not found. Creating NSSM service..."

              & $nssm install $serviceName $node $app
              & $nssm set $serviceName AppDirectory $appDir
              & $nssm set $serviceName Start SERVICE_AUTO_START
              & $nssm set $serviceName AppStdout "$appDir\nssm-out.log"
              & $nssm set $serviceName AppStderr "$appDir\nssm-err.log"

              & $nssm start $serviceName
          }

      # -------------------------------------------------
      # 7Ô∏è‚É£ Frontend npm install (LOCK FILE STRICT)
      # -------------------------------------------------
      - name: Install frontend dependencies
        shell: powershell
        run: |
          if (Test-Path node_modules) {
            Remove-Item -Recurse -Force node_modules
          }
          npm ci --legacy-peer-deps

      # -------------------------------------------------
      # 8Ô∏è‚É£ Build frontend
      # -------------------------------------------------
      - name: Build frontend
        shell: powershell
        run: |
          $env:CI="false"
          $env:GENERATE_SOURCEMAP="false"
          npm run build

      # -------------------------------------------------
      # 9Ô∏è‚É£ Deploy frontend to IIS
      # -------------------------------------------------
      - name: Deploy frontend to IIS
        shell: powershell
        run: |
          robocopy build C:\inetpub\wwwroot\kanakkuputhakam\build /MIR /XF web.config
          if ($LASTEXITCODE -le 7) { exit 0 } else { exit $LASTEXITCODE }

      # -------------------------------------------------
      # üîü Capture JOB END TIME (IST)
      # -------------------------------------------------
      - name: Capture Job End Time (IST)
        if: always()
        shell: powershell
        run: |
          $ist = Get-Date
          $log = "D:\Action-Runners\kpm-runner\_diag\job-runtime-IST.log"
          "END   | $($ist.ToString('yyyy-MM-dd HH:mm:ss')) | Repo=$env:GITHUB_REPOSITORY | RunId=$env:GITHUB_RUN_ID | Status=${{ job.status }}" | Out-File -Append $log
