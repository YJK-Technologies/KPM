import { useState } from "react";
import * as React from 'react';
import '../../App.css';
import { AgGridReact } from 'ag-grid-react';
import { toast } from 'react-toastify';
import {
  ModuleRegistry,
  ClientSideRowModelModule,
  PaginationModule,
  TextFilterModule,
  NumberFilterModule,
  DateFilterModule,
  CustomFilterModule,
  CellStyleModule,
  ValidationModule
} from 'ag-grid-community';

// Register necessary modules
ModuleRegistry.registerModules([
  ClientSideRowModelModule,
  PaginationModule,
  TextFilterModule,
  NumberFilterModule,
  DateFilterModule,
  CustomFilterModule,
  CellStyleModule,
  ValidationModule,
]);
const config = require('../../ApiConfig');

const CustomerHelpPopup = ({ open, handleClose, handleVendor }) => {

  const [rowData, setRowData] = useState([]);
  const [customer_code, setCustomer_code] = useState("");
  const [customer_name, setCustomer_name] = useState("");
  const [status, setStatus] = useState("");
  const [customer_state, setCustomer_state] = useState("");

  const handleSearchItem = async () => {
    try {
      const response = await fetch(`${config.apiBaseUrl}/customerSearchdata`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ company_code: sessionStorage.getItem('selectedCompanyCode'), customer_code, customer_name, status, customer_state, })
      });
      if (response.ok) {
        const searchData = await response.json();
        setRowData(searchData);
        console.log("data fetched successfully")
      } else if (response.status === 404) {
        toast.warning('Data not found!', {
          onClose: () => {
            setRowData([]);
            clearInputs([])
          }
        })
      } else {
        const errorResponse = await response.json();
        console.error(errorResponse.error);
        toast.error(errorResponse.message);
      }
    } catch (error) {
      console.error("Error fetching search data:", error);
    }
  };

  const handleReload = () => {
    clearInputs([])
    setRowData([])
  };

  const clearInputs = () => {
    setCustomer_code("");
    setCustomer_name("");
    setStatus("");
    setCustomer_state("");
  };

  const [selectedRows, setSelectedRows] = useState([]);

  const handleRowSelected = (event) => {
    setSelectedRows(event.api.getSelectedRows());
  };

  const handleConfirm = () => {
    const selectedData = selectedRows.map(row => ({
      CustomerCode: row.customer_code,
      CustomerName: row.customer_name,
      Address1: row.customer_addr_1,
      Address2: row.customer_addr_2,
      Address3: row.customer_addr_3,
      Address4: row.customer_addr_4,
      State: row.customer_state,
      Country: row.customer_country,
      MobileNo: row.customer_mobile_no,
      ContactPerson: row.contact_person,
      GSTNo: row.customer_gst_no,
    }));
    console.log('Selected Data:', selectedData);
    handleVendor(selectedData);
    handleClose();
    clearInputs([]);
    setRowData([]);
    setSelectedRows([]);
  }

  const columnDefs = [
    {
      checkboxSelection: true,
      headerName: "Customer Code",
      field: "customer_code",
      editable: false,
      cellStyle: { textAlign: "left" },
      valueFormatter: (params) => {
        return params.value ? params.value.toUpperCase() : '';
      },
    },
    {
      headerName: "Customer Name",
      field: "customer_name",
      editable: false,
      cellStyle: { textAlign: "left" },
      valueFormatter: (params) => {
        return params.value ? params.value.toUpperCase() : '';
      },
    },
    {
      headerName: "Status",
      field: "status",
      editable: false,
      cellStyle: { textAlign: "left" },
      valueFormatter: (params) => {
        return params.value ? params.value.toUpperCase() : '';
      },
    },
    {
      headerName: "Pan no",
      field: "panno",
      editable: false,
      cellStyle: { textAlign: "left" },
      valueFormatter: (params) => {
        return params.value ? params.value.toUpperCase() : '';
      },
    },
    {
      headerName: "Customer GST No",
      field: "customer_gst_no",
      editable: false,
      cellStyle: { textAlign: "left" },
      valueFormatter: (params) => {
        return params.value ? params.value.toUpperCase() : '';
      },
    },
    {
      headerName: "Customer Address 1",
      field: "customer_addr_1",
      editable: false,
      cellStyle: { textAlign: "left" },
      valueFormatter: (params) => {
        return params.value ? params.value.toUpperCase() : '';
      },
    },
    {
      headerName: "Customer Address 2",
      field: "customer_addr_2",
      editable: false,
      cellStyle: { textAlign: "left" },
      valueFormatter: (params) => {
        return params.value ? params.value.toUpperCase() : '';
      },
    },
    {
      headerName: "Customer Address 3",
      field: "customer_addr_3",
      editable: false,
      cellStyle: { textAlign: "left" },
      valueFormatter: (params) => {
        return params.value ? params.value.toUpperCase() : '';
      },
    },
    {
      headerName: "Customer Address 4",
      field: "customer_addr_4",
      editable: false,
      cellStyle: { textAlign: "left" },
      valueFormatter: (params) => {
        return params.value ? params.value.toUpperCase() : '';
      },
    },
    {
      headerName: "Customer Area",
      field: "customer_area",
      editable: false,
      cellStyle: { textAlign: "left" },
      valueFormatter: (params) => {
        return params.value ? params.value.toUpperCase() : '';
      },
    },
    {
      headerName: "State",
      field: "customer_state",
      editable: false,
      cellStyle: { textAlign: "left" },
      valueFormatter: (params) => {
        return params.value ? params.value.toUpperCase() : '';
      },
    },
    {
      headerName: "Country",
      field: "customer_country",
      editable: false,
      cellStyle: { textAlign: "left" },
      valueFormatter: (params) => {
        return params.value ? params.value.toUpperCase() : '';
      },
    },
    {
      headerName: "Mobile No",
      field: "customer_mobile_no",
      editable: false,
      cellStyle: { textAlign: "left" },
      valueFormatter: (params) => {
        return params.value ? params.value.toUpperCase() : '';
      },
    },
    {
      headerName: "Residential No",
      field: "customer_resi_no",
      editable: false,
      cellStyle: { textAlign: "left" },
      valueFormatter: (params) => {
        return params.value ? params.value.toUpperCase() : '';
      },
    },
    {
      headerName: "Office No",
      field: "customer_office_no",
      editable: false,
      cellStyle: { textAlign: "left" },
    },
  
 
    {
      headerName: "Email ID",
      field: "customer_email_id",
      editable: false,
      cellStyle: { textAlign: "left" },
      valueFormatter: (params) => {
        return params.value ? params.value.toUpperCase() : '';
      },
    },
  
    {
      headerName: "Salesman Code",
      field: "customer_salesman_code",
      editable: false,
      cellStyle: { textAlign: "left" },
      valueFormatter: (params) => {
        return params.value ? params.value.toLowerCase() : '';
      },
    },

    {
      headerName: "Contact Person",
      field: "contact_person",
      editable: false,
      cellStyle: { textAlign: "left" },
    }
  ];

  const defaultColDef = {
    resizable: true,
    wrapText: true,
    sortable: true,
    editable: false,
  };

  return (
    <div className="container-fluid mt-0  m-5">
      {open && (
        <div className={`modal fade show d-block`} tabIndex="-1" role="dialog" style={{ backgroundColor: "rgba(0,0,0,0.5)" }}>
          <div className="modal-dialog modal-dialog-centered modal-lg mt-0 " role="document" >
            <div className="modal-content rounded-4 shadow-lg">
              <div className="modal-header">
                <h5 className="modal-title fw-bold fs-3">Customer Help</h5>
                <button type="button" className="btn-close" onClick={handleClose}></button>
              </div>
              <div className="modal-body">
                <div className="row">
                  <div className="col-md-3 mb-2">
                    <label className="fw-bold">Customer Code</label>
                    <input
                      type="text"
                      className="form-control"
                      id='Vendor_code'
                      maxLength={10}
                      value={customer_code}
                      onChange={(e) => setCustomer_code(e.target.value)}
                      onKeyDown={(e) => e.key === 'Enter' && handleSearchItem()}
                      autoComplete="off"
                    />
                  </div>
                  <div className="col-md-3 mb-2">
                    <label className="fw-bold">Customer Name </label>
                    <input
                      type="text"
                      className="form-control"
                      id='Variant'
                      value={customer_name}
                      maxLength={250}
                      onChange={(e) => setCustomer_name(e.target.value)}
                      onKeyDown={(e) => e.key === 'Enter' && handleSearchItem()}
                      autoComplete="off"
                    />
                  </div>
                  <div className="col-md-3 mb-2">
                    <label className="fw-bold">Status </label>
                    <input
                      type="text"
                      className="form-control"
                      value={status}
                      maxLength={18}
                      onChange={(e) => setStatus(e.target.value)}
                      onKeyDown={(e) => e.key === 'Enter' && handleSearchItem()}
                      autoComplete="off"
                    />
                  </div>
                  <div className="col-md-3 mb-2">
                    <label className="fw-bold">State</label>
                    <input
                      type="text"
                      className="form-control"
                      value={customer_state}
                      maxLength={100}
                      onChange={(e) => setCustomer_state(e.target.value)}
                      onKeyDown={(e) => e.key === 'Enter' && handleSearchItem()}
                      autoComplete="off"
                    />
                  </div>
                  <div className="col-md-3 mb-2 mt-4">
                    <button className="btn btn-primary pt-1" onClick={handleSearchItem} title="Search">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
                    </svg>
                    </button>
                    <button className="btn btn-primary pt-1 ms-2" onClick={handleReload} title="Reload">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" className="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                        <path fillRule="evenodd" d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 1 0-.908-.418A6 6 0 1 0 8 2v1z" />
                        <path d="M8 1a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5H5a.5.5 0 0 1 0-1h2.5V1.5A.5.5 0 0 1 8 1z" />
                      </svg>
                    </button>
                    <button className="btn btn-primary pt-1 ms-2" onClick={handleConfirm} title="Confirm">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" className="bi bi-check" viewBox="0 0 16 16">
                        <path d="M13.854 3.646a.5.5 0 0 1 0 .708L6.707 11.5l-3.5-3.5a.5.5 0 0 1 .708-.708L6.707 10.293l6.439-6.439a.5.5 0 0 1 .708 0z" />
                      </svg>
                    </button>
                  </div>
                </div>
                <div className="ag-theme-alpine mt-4" style={{ height: 330, width: '100%' }}>
                  <AgGridReact
                    rowData={rowData}
                    columnDefs={columnDefs}
                    defaultColDef={defaultColDef}
                    rowSelection="multiple"
                    pagination
                    onSelectionChanged={handleRowSelected}
                  />
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default CustomerHelpPopup;
